#!/usr/bin/python3
import socket
from _thread import *

def threaded(client, addr):
    print('Connected by :', addr[0], ':', addr[1])

    while True:

        try:
            filename = '/root/data/server/result/result.log'
            data_transferred = 0
            data = client.recv(1024)
            with open(filename, 'wb') as f:
                try:
                    while data:
                        f.write(data)
                        data_transferred += len(data)
                        data = client.recv(1024)

                        if "time_info" in data:
                            while data:
                                filename2 = '/root/data/server/result/work.log'
                                data_transferred2 = 0
                                data = client.recv(1024)
                                f = open(filename2,'a+')
                                f.write(data)
                                data_transferred2 += len(data)
                                print('파일 %s 받기 완료. 전송량 %d' % (filename2, data_transferred2))

                except Exception as ex:
                    print(ex)
            print('파일 %s 받기 완료. 전송량 %d' % (filename, data_transferred))

            if not data:
                print('Disconnected by ' + addr[0], ':', addr[1])
                break

            print('Received from ' + addr[0], ':', addr[1], data.decode())

            client.send(data)

        except ConnectionResetError as e:

            print('Disconnected by ' + addr[0], ':', addr[1])
            break

    client.close()


server = socket.socket()
server.bind(('172.31.45.126', 9999))
server.listen(1)
print("server open!")

while True:
    client, addr = server.accept()
    start_new_thread(threaded, (client, addr))

client.close()
server.close()