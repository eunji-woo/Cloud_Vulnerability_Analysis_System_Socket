#!/usr/bin/python3
import socket
from _thread import *

def threaded(client, addr):
    print('Connected by :', addr[0], ':', addr[1])

    while True: # 클라이언트가 접속을 끊을 때 까지 반복

        try:
            filename = 'result.log'
            data_transferred = 0
            data = client.recv(1024)
            with open("/home/centos/data/server/result" + "/" + filename, 'wb') as f:
                try:
                    while data:
                        f.write(data)
                        data_transferred += len(data)
                        data = client.recv(1024)
                except Exception as ex:
                    print(ex)
            print('파일 %s 받기 완료. 전송량 %d' % (filename, data_transferred))

            if not data:
                print('Disconnected by ' + addr[0], ':', addr[1])
                break

            print('Received from ' + addr[0], ':', addr[1], data.decode())

            client.send(data)

        except ConnectionResetError as e:

            print('Disconnected by ' + addr[0], ':', addr[1])
            break

    client.close()


server = socket.socket()
server.bind(('172.31.8.131', 9999))
server.listen(1)
print("server open!")

while True:
    client, addr = server.accept()
    start_new_thread(threaded, (client, addr))

client.close()
server.close()
