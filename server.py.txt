#!/usr/bin/python3

import socket
from _thread import *
import sys
import pymysql

def threaded(client, addr):
    print('Connected by :', addr[0], ':', addr[1])
    
    while True:

        try:
            data = client.recv(1024)
            if data.decode() == 'shell_code':
                db = pymysql.connect(host="localhost", port=3306, user="root", password="toor", database="bbomain",
                                     charset='utf8')
                cursor = db.cursor()
                sql = "SELECT * FROM vuln_shell_list"
                cursor.execute(sql)
                result = cursor.fetchall()

                for record in result:
                    print(record)
                    msg = record[1].encode()
                    length = len(msg)
                    client.send(length.to_bytes(4, byteorder="little"))
                    client.send(msg)                         
                db.close()

            if not data:
                print('Disconnected by ' + addr[0], ':', addr[1])
                break

            print('Received from ' + addr[0], ':', addr[1], data.decode())

        except ConnectionResetError as e:
            print('Disconnected by ' + addr[0], ':', addr[1])
            break

    client.close()


server = socket.socket()
server.bind(('172.31.45.126', 9999))
server.listen(1)
print("server open!")

while True:
    client, addr = server.accept()
    start_new_thread(threaded, (client, addr))

client.close()
server.close()