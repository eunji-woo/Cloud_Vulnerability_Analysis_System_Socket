#!/usr/bin/python3
import socket
import os
import pymysql

db = pymysql.connect(host="localhost", port=3306, user="root", password="toor", database="bbomain", charset='utf8')
cursor = db.cursor()
sql = "SELECT vuln_shell_code FROM vuln_shell_list"
cursor.execute(sql)
result = cursor.fetchall()

for record in result:
    os.system(record[0])
db.close()

ip = '172.31.45.126'
port = 9999

client = socket.socket()
client.connect((ip, port))
print("connected with server")

data_transferred = 0
print("result.log 파일 전송 시작")

result_file = open("result.log", 'r')
seek_file = open("seek.txt", 'rb+')

try:
    seek_location = int(seek_file.readline())
    if seek_location == '':
        result_file.seek(0)
    else:
        result_file.seek(seek_location)
    data = result_file.read(1024)
    while data:
        data_transferred += client.send(data)
        data = result_file.read(1024)
    print(result_file.tell())
    seek_file.write(str(result_file.tell()).encode())
    seek_file.write("\n".encode())
except Exception as ex:
    print(ex)

print("result.log 전송완료, 전송량 %d" % data_transferred)

client.close()
